<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sistema Orlando</title>
    <link rel="apple-touch-icon" sizes="180x180" href="favicon_io/apple-touch-icon.png?v=1">
    <link rel="icon" type="image/png" sizes="32x32" href="favicon_io/favicon-32x32.png?v=1">
    <link rel="icon" type="image/png" sizes="16x16" href="favicon_io/favicon-16x16.png?v=1">
    <link rel="shortcut icon" href="favicon_io/favicon.ico?v=1" type="image/x-icon">
    <link rel="manifest" href="favicon_io/site.webmanifest?v=1">
    <style>
        html, body {
            margin: 0;
            padding: 0;
            height: 100%;
            width: 100%;
            overflow: hidden;
            background-color: #0d1117; 
        }
        
        #app-frame {
            width: 100vw;  
            height: 100vh;  
            border: none;   
            display: block;
        }
    </style>
</head>
<body>

<script>
(function(){
    // 1. Tu URL Encriptada
const encodedParts = [
  "aHR0cHM6Ly9zY3JpcHQuZ29vZ2xlLmNvbS9tYW",
  "Nyb3Mvcy9BS2Z5Y2J3emhndTBJOVhtbUdMLWh6",
  "eVBmaC0zMjBmd1l3VHQwcTQxcld4MXRjTTdIc0",
  "xrOGxQWHBiYWpZR2JYbFpkX0hsQVBrQS9leGVj"
];

    let FALLBACK_IFRAME_SRC = "";
    try {
        FALLBACK_IFRAME_SRC = atob(encodedParts.join(""));
    } catch (e) {
        FALLBACK_IFRAME_SRC = "";
    }

    // ---------------------------------------------------------
    // CORRECCIÓN: Capturar QUERY PARAMETERS (?product_id=...)
    // ---------------------------------------------------------
    // Necesitamos pasar todo lo que viene después del dominio (pathname + search)
    // Ejemplo: si entras a tusitio.com/?product_id=5
    let fullPath = window.location.pathname + window.location.search;
    
    if (fullPath === "/" || fullPath === "/index.html") {
        fullPath = ""; // Opcional, depende de cómo manejes el home
    } else if (window.location.search) {
        // Si hay parámetros, asegurémonos de pasarlos
        fullPath = window.location.search; 
    }
    
    // Agregamos el parámetro 'page' a la URL de Google Apps Script
    if (FALLBACK_IFRAME_SRC) {
        const separator = FALLBACK_IFRAME_SRC.includes('?') ? '&' : '?';
        // Pasamos el parámetro como 'startPage' para leerlo dentro de GAS
        FALLBACK_IFRAME_SRC += separator + "startPage=" + encodeURIComponent(fullPath);
    }

    // --- CSS ---
    const css = `
    .embed-fullscreen{position:relative;width:100%;height:100vh;overflow:hidden;background:#000}
    .embed-fullscreen iframe{position:absolute;inset:0;width:100%;height:100%;border:0;display:block;background:#fff}
    `;
    const style = document.createElement("style");
    style.textContent = css;
    document.head.appendChild(style);

    // --- Crear contenedor ---
    const container = document.createElement("div");
    container.className = "embed-fullscreen";

    // --- Iframe ---
    const iframe = document.createElement("iframe");
    iframe.id = "auth-iframe";
    iframe.title = "Sistema Integrado";
    iframe.loading = "eager";
    iframe.setAttribute("allow","clipboard-read; clipboard-write");
    iframe.setAttribute("referrerpolicy","no-referrer-when-downgrade");
    iframe.scrolling = "yes";

    if (FALLBACK_IFRAME_SRC) {
        iframe.src = FALLBACK_IFRAME_SRC;
    } else {
        iframe.src = "about:blank";
    }

    container.appendChild(iframe);

    if (document.body) {
        document.body.appendChild(container);
    } else {
        window.addEventListener('DOMContentLoaded', function(){ document.body.appendChild(container); });
    }

    // ---------------------------------------------------------
    // LISTENER DE MENSAJES (Corregido para actualizar URL)
    // ---------------------------------------------------------
    window.addEventListener('message', function(e) {
        // Validar origen de Google
        if (e.origin.includes("script.google.com") || e.origin.includes("googleusercontent.com")) {
            const data = e.data;
            
            // Acción para actualizar la URL del navegador
            if (data.action === 'updateUrl' && data.path) {
                try {
                    // Si path es solo "?product_id=1", pushState lo maneja correctamente
                    window.history.pushState({path: data.path}, data.title || '', data.path);
                    if(data.title) document.title = data.title;
                } catch(err) {
                    console.error("Error actualizando URL:", err);
                }
            }
        }
    });

    // --- Neutralizar logs ---
    (function protectConsole(){
        const origLog = console.log.bind(console);
        const origWarn = console.warn.bind(console);
        const origError = console.error.bind(console);

        function blockIfContains(args){
            try {
                return args.some(a => {
                    if (typeof a === 'string') {
                        return a.includes("script.google.com") || a.includes("googleusercontent");
                    }
                    return String(a).includes("script.google.com") || String(a).includes("googleusercontent");
                });
            } catch(e){ return false; }
        }

        console.log = function(...args){ if (blockIfContains(args)) return; origLog(...args); };
        console.warn = function(...args){ if (blockIfContains(args)) return; origWarn(...args); };
        console.error = function(...args){ if (blockIfContains(args)) return; origError(...args); };
    })();

})();
</script>
    

</body>
</html>


